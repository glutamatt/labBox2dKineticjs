<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
      canvas {
        border: 1px solid #9C9898;
      }
    </style>
    <script src="http://www.html5canvastutorials.com/libraries/kinetic-v3.10.0.js"></script>
    <script type="text/javascript" src="https://raw.github.com/joelgwebber/bench2d/master/js/Box2dWeb-2.1a.3/Box2dWeb-2.1.a.3.min.js"></script>
     <script src="http://localhost:8080/socket.io/socket.io.js"></script>
    <script>

    
    
var coefTest = 30 ;

var actors = new Array() ;

    //box2d
var   b2Vec2 = Box2D.Common.Math.b2Vec2
         	,	b2BodyDef = Box2D.Dynamics.b2BodyDef
         	,	b2Body = Box2D.Dynamics.b2Body
         	,	b2FixtureDef = Box2D.Dynamics.b2FixtureDef
         	,	b2Fixture = Box2D.Dynamics.b2Fixture
         	,	b2World = Box2D.Dynamics.b2World
         	,	b2MassData = Box2D.Collision.Shapes.b2MassData
         	,	b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
         	,	b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
         	,	b2DebugDraw = Box2D.Dynamics.b2DebugDraw
            ;
            
            
world = new b2World(
 new b2Vec2(0, 10)    //gravity
 ,  true                 //allow sleep
 );       


var myListener = new Box2D.Dynamics.b2ContactListener;
myListener.PostSolve = function(contact , impulse) {
	   console.log('contact : ' + contact);
}
world.SetContactListener(myListener);




function createRectBody(w, h , x, y , wi, hi)
{
	var fixDef = new b2FixtureDef;
    fixDef.density = 1.0;
    fixDef.friction = 0.5;
    fixDef.restitution = 0.2;
    
var bodyDef = new b2BodyDef;
bodyDef.type = b2Body.b2_dynamicBody;  
  fixDef.shape = new b2PolygonShape;
          fixDef.shape.SetAsBox(
                w / 2
             ,  h / 2
          ); 
           bodyDef.position.x = x;
       bodyDef.position.y = y;
       var testBody = world.CreateBody(bodyDef);
       testBody.CreateFixture(fixDef); 
       testBody.SetBullet(true);	
       testBody.ApplyImpulse(new b2Vec2(wi, hi), new b2Vec2(testBody.GetPosition().x,testBody.GetPosition().y ));
       
       return testBody ;
}

function addRectActor(layer, orientation, power)
{
	w = Math.random() * 50 ;
	h = Math.random() * 50 ;
	w = 0.3 * 50 ;
	h = 0.3  * 50 ;
	y = Math.random() *10 ;
	x = Math.random() *300 ;
	y = 200 ;
	x = 300 ;
	
	if(!orientation)orientation = 0 ;
	if(!power)power = 0 ;
	
	power = power * 0.005 ;
	
	hi = Math.sin(orientation * 3.14/180)  * -1 * power;
	wi = Math.cos(orientation * 3.14/180) * -1 * power ;
	
	hexagon = createRectSprite(w, h) ;
	body = createRectBody(w / coefTest, h/ coefTest , x/ coefTest, y/ coefTest , wi, hi);
	actors.push({
		body: body ,
		sprite : hexagon,
		draw:(function(hexagon, testBody, w,h){	   
			
			return function()
			{
				
			hexagon.setX(  testBody.GetPosition().x * coefTest );
		hexagon.setY(  testBody.GetPosition().y * coefTest ) ;
		hexagon.setRotation(testBody.GetAngle());
			}
		
		})(hexagon, body, w,h)
	
	
	});
	 layer.add(hexagon);    
}

function createRectSprite(w, h)
{
	
	return new Kinetic.Rect({
        x: 0,
        y: 0,
        width: w ,
        height: h ,
        fill: "#00D2FF",
        stroke: "black",
        strokeWidth: 2,
        offset: [ w/ 2 , h   / 2]
      });
}

      //groud
var fixDef = new b2FixtureDef;
         fixDef.density = 1.0;
         fixDef.friction = 0.5;
         fixDef.restitution = 0.2;
             var bodyDef = new b2BodyDef;
      bodyDef.type = b2Body.b2_staticBody;  
      fixDef.shape = new b2PolygonShape;
fixDef.shape.SetAsBox(300 / coefTest, 10/coefTest);
      bodyDef.position.y = 300  / coefTest ;
      bodyDef.position.x =300  / 2 / coefTest ;
world.CreateBody(bodyDef).CreateFixture(fixDef); 



var layer = new Kinetic.Layer();

      window.onload = function() {
    	  
    	  init();
      
      
       //setup debug draw
         var debugDraw = new b2DebugDraw();
			debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
			debugDraw.SetDrawScale(30.0);
			debugDraw.SetFillAlpha(0.3);
			debugDraw.SetLineThickness(1.0);
			debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
			world.SetDebugDraw(debugDraw);  
			
			
        var stage = new Kinetic.Stage({
          container: "container",
          width: 300,
          height: 300
        });
        
        stage.add(layer);

        var amplitude = 150;
        var period = 2000;
        // in ms
        var centerX = stage.getWidth() / 2;

        stage.onFrame(function(frame) {
        
       world.Step(
               1 / 40   //frame-rate
            ,  10       //velocity iterations
            ,  10       //position iterations
         );
         world.DrawDebugData();
         world.ClearForces();
         world.DrawDebugData();
         
         
         for (i = 0 ; i < actors.length ; i++)
        	 {
        	 
        	actors[i].draw()
        	 }

			
          layer.draw();
        });

        stage.start();
      };

      
      function init()
      {
    	  document.getElementById("new").onclick = function(){
    		  addRectActor(layer) ;
    	  }
      }
      
      
      var socket = io.connect('http://192.168.0.122:8080/game');
      socket.on('fire', function (data) {
    	  console.log (data.power) ;
      	addRectActor(layer, data.orientation, data.power) ;
        });
      
    </script>
  </head>
  <body>
    <div id="container"></div>
    <canvas id="canvas" width="300" height="300"></canvas>
    <button id="new">NEW</button>
  </body>
</html>
